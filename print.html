<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GBA From Scratch With Rust</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="initial-setup/index.html"><strong aria-hidden="true">1.</strong> Initial Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="initial-setup/minimal-example.html"><strong aria-hidden="true">1.1.</strong> A Minimal Example</a></li><li class="chapter-item expanded "><a href="initial-setup/calling-main.html"><strong aria-hidden="true">1.2.</strong> Calling main</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GBA From Scratch With Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to <em>GBA From Scratch With Rust</em>.</p>
<p>It's a book about programming for the Game Boy Advance using the Rust programming langauge.
Particularly, everything will be as &quot;from scratch&quot; as possible.
This means that we'll use the <code>core</code> part of the standard library,
but for all other code it'll be stuff we've covered how to make in the book.</p>
<p>If you want to write 20 lines of code to call a few library functions and have a working Pong clone, this book is <strong>NOT</strong> for you.
This is <em>not</em> the quick path to having a completed game.
This is the much slower path of learning how all the things are happening under the hood.
If that kind of thing sounds like fun, then this book is probably for you.</p>
<p>Doing things from scratch is <em>not</em> a time-efficient way to complete a project,
but it is a pretty good way to learn about all the layers that go into something.</p>
<h2 id="expected-background"><a class="header" href="#expected-background">Expected Background</a></h2>
<p>The primary expected background for reading is book is a basic understanding of the Rust language itself.
You'll also need to be familiar with using <code>cargo</code> based projects, which most every Rust programmer already is.
The usual way to learn Rust is by reading <a href="https://doc.rust-lang.org/book/">The Rust Programming Language</a>,
but any similar introduction to the language should suffice.</p>
<p>We will definitely be using many advanced features of Rust to get things done,
but those parts I will explain as we go.</p>
<p>Also, a general familiarity with using command line tools is probably a good idea,
but if you're familiar with <code>cargo</code> then you probably know enough to get started.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>This book is available under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International</a> license.
Also known as &quot;CC BY-NC-SA 4.0&quot;, for short.
In simple terms it means that you can redistribute this book (with or without changes) as long as you give credit,
as long as it's not for commercial purposes,
and as long as you don't change the license.
If you need more details you can follow the link and read the full text of the license.</p>
<h2 id="support"><a class="header" href="#support">Support</a></h2>
<p>If you'd like to support the book you can sign up to be a <a href="https://github.com/sponsors/Lokathor">Github Sponsor</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initial-setup"><a class="header" href="#initial-setup">Initial Setup</a></h1>
<blockquote>
<p>If you want to make an apple pie from scratch, you must first invent the universe.</p>
</blockquote>
<p>In other words, we've got a lot of setup ahead of us.</p>
<h1 id="system-tooling-setup"><a class="header" href="#system-tooling-setup">System Tooling Setup</a></h1>
<p>Separately from setting up a specific project's configuration, you'll need to do a few &quot;one time&quot; things to make your machine ready.</p>
<p>First of all, we'll need to be using the Nightly rust compiler, because we'll be using a lot of unstable features.</p>
<p>Next, we'll need to have the <code>rust-src</code> rustup component available, because we'll have to build our own copy of the standard library.</p>
<p>Finally, we'll need the ARM binutils because LLVM's linker doesn't currently support the GBA's old CPU (but support is in the works).
You can get the ARM binutils for Windows and Mac from the <a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">ARM Developer Website</a>.
If you're on Linux then you can probably find them in your package manager.
We want a set of binutils for <code>arm-none-eabi</code>.</p>
<p>Here's the lines to make the (ubuntu based) CI run:</p>
<pre><code class="language-sh">rustup default nightly
rustup component add rust-src
sudo apt-get install -y binutils-arm-none-eabi
</code></pre>
<p>The <code>rust-src</code> component will be specific to Nightly or Stable, so be sure to set Nightly before installing it.
Otherwise you'll just have to install it a second time after setting Nightly for use.</p>
<p>The rustup commands should work just as well on Windows and Mac.
If you're on a Linux that isn't Ubuntu then the binutils package could be under some other name.</p>
<p><strong>Note:</strong> <code>rustup default nightly</code> is a global command and will affect all your rust stuff.
If you want to sets nightly for <em>only</em> your GBA project the consider a <a href="https://rust-lang.github.io/rustup/overrides.html?#the-toolchain-file">toolchain file</a> instead.</p>
<p>We'll also need a tool called <code>gbafix</code>, which can patch up the ROM's header data.
There's a <a href="https://github.com/devkitPro/gba-tools">C version</a> of that if you want,
but there's also a rust one too, and you can just get the Rust version via <code>cargo install</code>.</p>
<pre><code class="language-sh">cargo install gbafix
</code></pre>
<h1 id="project-configuration"><a class="header" href="#project-configuration">Project Configuration</a></h1>
<p>In addition to the system level setup, we'll want to set a few project configuration files before we begin working on the actual code.</p>
<h2 id="cargotoml"><a class="header" href="#cargotoml"><code>Cargo.toml</code></a></h2>
<p>Running the usual <code>cargo init</code> will make a default <code>Cargo.toml</code> file.
This is mostly fine, but I strongly suggest that we alter the &quot;dev&quot; build profile slightly.
The dev profile is what's used for debug builds.
Normally the dev profile is set for a low level of optimization and using incremental building.
This lets debug builds complete quickly, though the resulting programs run an order of magnitude (or more) slower than a release build.
The GBA has a very weak CPU, so taking such a performance hit, even just in debug builds, is very bad for us.</p>
<p>We want to turn the <code>opt-level</code> up to 3, and turn <code>incremental</code> off.</p>
<p>Also, we can use a package override to turn <code>debug-assertions</code> off in our dependencies.
We won't have any normal dependencies, but we'll be using the <code>build-std</code> nightly feature of <code>cargo</code>.
When <code>cargo</code> builds the standard library it'll pull in <code>compiler_builtins</code>, and we want that to avoid those debug asserts.</p>
<pre><code class="language-toml">[profile.dev]
opt-level = 3
incremental = false

[profile.dev.package.&quot;*&quot;]
debug-assertions = false
</code></pre>
<h2 id="cargoconfigtoml"><a class="header" href="#cargoconfigtoml"><code>.cargo/config.toml</code></a></h2>
<p>In our project folder make a <code>.cargo/</code> folder, then make a <code>cargo.toml</code> file inside.
This lets us change a few more cargo defaults so that we don't need to pass as many command line arguments all the time.</p>
<p>First of all, our default target for all of our builds will be <code>thumbv4t-none-eabi</code>.
There's two targets built in to <code>rustc</code> that could work on the GBA:</p>
<ul>
<li><code>thumbv4t-none-eabi</code> produces &quot;thumb code&quot; by default</li>
<li><code>armv4t-none-eabi</code> produces &quot;arm code&quot; by default</li>
</ul>
<p>We'll cover the thumb/arm differences later,
for now just know that we'll want a majority of our code to be thumb code so we'll be building with <code>thumbv4t-none-eabi</code>.
We can set this with <code>--target=thumbv4t-none-eabi</code>, but we can also use a <code>[build]</code> entry.</p>
<pre><code class="language-toml">[build]
target = &quot;thumbv4t-none-eabi&quot;
</code></pre>
<p>The thing is, there's no standard library shipped for this target, it's only &quot;<a href="https://doc.rust-lang.org/rustc/target-tier-policy.html">Tier 3</a>&quot;.
This isn't a very big problem, because a Nightly feature of <code>cargo</code> lets us build it ourselves.
It makes a fresh project build take an extra few seconds, but that's it.
We could do this with <code>-Zbuild-std=core</code>, or we can use an <code>[unstable]</code> entry.</p>
<pre><code class="language-toml">[unstable]
build-std = [&quot;core&quot;]
</code></pre>
<p>Last up is that we want to set some per-target details.
With a <code>runner</code> we can name a program that will run our programs.
This is designed to support emulators and simulators and the like, which is exactly what we want.
My GBA emulator of choice is <a href="https://mgba.io/">mGBA</a>, and <code>0.10</code> is the latest version of mGBA as I write this.
On Linux and Mac you'll get two executables: <code>mgba</code> will have no GUI controls, and <code>mgba-qt</code> will have GUI controls.
On Windows there's just one executable: <code>mgba.exe</code>.
Personally, on my Windows machine I just made a copy of <code>mgba.exe</code> called <code>mgba-qt.exe</code>.
Then I didn't have to worry about the per-OS difference, I just set the runner as &quot;mgba-qt&quot; and it works.</p>
<p>In addition to the <code>runner</code>, we need to set some special <code>rustflags</code>.
There's a special argument we need to pass to the linker.
We do this with <code>-Clink-arg=</code>, followed by the argument.
The linker argument itself that we need to pass will be to set the linker script.
We do this with <code>-T</code>, followed by the script's filename.
I'm going to suggest having a folder called <code>linker_scripts/</code>, and then a script called <code>mono_boot.ld</code>.
That means that our <code>[target.thumbv4t-none-eabi]</code> entry will look like this</p>
<pre><code class="language-toml">[target.thumbv4t-none-eabi]
runner = &quot;mgba-qt&quot;
rustflags = [&quot;-Clink-arg=-Tlinker_scripts/mono_boot.ld&quot;]
</code></pre>
<p>The linker script file itself is complicated enough to deserve its own sub-header.</p>
<h2 id="linker_scriptsmono_bootld"><a class="header" href="#linker_scriptsmono_bootld"><code>linker_scripts/mono_boot.ld</code></a></h2>
<p>todo</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="minimal-example"><a class="header" href="#minimal-example">Minimal Example</a></h1>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>#![no_std]
#![no_main]
#![feature(naked_functions)]

<span class="boring">fn main() {
</span>#[naked]
#[no_mangle]
#[instruction_set(arm::a32)]
#[link_section = &quot;.text.gba_rom_header&quot;]
unsafe extern &quot;C&quot; fn __start() -&gt; ! {
  core::arch::asm! {
    &quot;b 1f&quot;,
    &quot;.space 0xE0&quot;,
    &quot;1:&quot;,
    &quot;b 1b&quot;,
    options(noreturn)
  }
}

#[panic_handler]
fn handle_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
  loop {}
}
<span class="boring">}</span></code></pre></pre>
<h2 id="building-an-elf-and-fixing-a-rom"><a class="header" href="#building-an-elf-and-fixing-a-rom">Building an ELF and Fixing a ROM</a></h2>
<p>todo</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="calling-main"><a class="header" href="#calling-main">Calling <code>main</code></a></h1>
<pre><pre class="playground"><code class="language-rust">#![no_std]
#![no_main]
#![feature(naked_functions)]

#[naked]
#[no_mangle]
#[instruction_set(arm::a32)]
#[link_section = &quot;.text.gba_rom_header&quot;]
unsafe extern &quot;C&quot; fn __start() -&gt; ! {
  core::arch::asm! {
    &quot;b 1f&quot;,
    &quot;.space 0xE0&quot;,
    &quot;1:&quot;,
    &quot;ldr r0, =main&quot;,
    &quot;bx r0&quot;,
    options(noreturn)
  }
}

#[no_mangle]
extern &quot;C&quot; fn main() -&gt; ! {
  unsafe {
    (0x0400_0000 as *mut u16).write_volatile(0);
  }
  loop {}
}

#[panic_handler]
fn handle_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
  loop {}
}</code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
