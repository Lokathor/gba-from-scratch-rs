<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bitpacked Structs - GBA From Scratch With Rust</title>


        <!-- Custom HTML head -->
        <!-- Open Graph tags-->
        <meta name="og:site_name" content="GBA From Scratch With Rust" />
        <meta name="og:title" content="Bitpacked Structs" />
        <meta name="og:description" content="" />
        
        <!-- Twitter meta tags -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@lokathor" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../initial-setup/index.html"><strong aria-hidden="true">1.</strong> Initial Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../initial-setup/minimal-example.html"><strong aria-hidden="true">1.1.</strong> A Minimal Example</a></li><li class="chapter-item expanded "><a href="../initial-setup/calling-main.html"><strong aria-hidden="true">1.2.</strong> Calling main</a></li><li class="chapter-item expanded "><a href="../initial-setup/volatile-ops.html"><strong aria-hidden="true">1.3.</strong> Volatile Ops</a></li><li class="chapter-item expanded "><a href="../initial-setup/bitpacked-structs.html" class="active"><strong aria-hidden="true">1.4.</strong> Bitpacked Structs</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GBA From Scratch With Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Lokathor/gba-from-scratch-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bitpacked-structs"><a class="header" href="#bitpacked-structs">Bitpacked Structs</a></h1>
<p>We've learned about using volatile to access MMIO, but that's just the storing and loading part.
The actual data that we store and load needs to be talked about too.
Most of the settings don't need an entire byte to express, so it saves tons of space if we pack them together.
Say we have a <code>u16</code>, normally we'd think of it as being one number.
But there's 16 bits in there, and we don't need to treat them as a single large group.
We can divide up the bits so that different spans of bits will mean different things.
When data is packed within sub-spans of an integer's bits it's called &quot;bitpacked&quot;.</p>
<p>Let's have an example.
We've mentioned the Display Control before, that it's at <code>0x0400_0000</code>.
If we check in <a href="https://problemkaputt.de/gbatek.htm">GBATEK</a> (the usual place for GBA hardware info) we can find the display control summary:</p>
<pre><code>4000000h - DISPCNT - LCD Control (Read/Write)
  Bit   Expl.
  0-2   BG Mode                (0-5=Video Mode 0-5, 6-7=Prohibited)
  3     Reserved / CGB Mode    (0=GBA, 1=CGB; can be set only by BIOS opcodes)
  4     Display Frame Select   (0-1=Frame 0-1) (for BG Modes 4,5 only)
  5     H-Blank Interval Free  (1=Allow access to OAM during H-Blank)
  6     OBJ Character VRAM Mapping (0=Two dimensional, 1=One dimensional)
  7     Forced Blank           (1=Allow FAST access to VRAM,Palette,OAM)
  8     Screen Display BG0  (0=Off, 1=On)
  9     Screen Display BG1  (0=Off, 1=On)
  10    Screen Display BG2  (0=Off, 1=On)
  11    Screen Display BG3  (0=Off, 1=On)
  12    Screen Display OBJ  (0=Off, 1=On)
  13    Window 0 Display Flag   (0=Off, 1=On)
  14    Window 1 Display Flag   (0=Off, 1=On)
  15    OBJ Window Display Flag (0=Off, 1=On)
</code></pre>
<p>For the Display Control, bits 0, 1, and 2 will combine to mean one value, the background mode.
Then bits 4 through 15 will each be a different boolean flag.</p>
<p>To model all this in Rust, we'll first make a &quot;newtype&quot;.
This is the common pattern where we take one type of data and give it a <code>repr(transparent)</code> wrapping.
This lets us associate new methods and trait impls with the type while keeping the wrapped data fully compatible with foreign code.
Usually &quot;foreign code&quot; means C code, but in our case it means MMIO as well.</p>
<p>First we wrap a <code>u16</code> under a new name.
Let's have a new module named <code>display_control</code> and start it off with this struct:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in display_control.rs
#[derive(Clone, Copy)]
#[repr(transparent)]
pub struct DisplayControl(u16);
<span class="boring">}</span></code></pre></pre>
<p>Now we want methods for getting and setting the video mode.
Also, we will need a method for making a starting value to run our getters and setters on.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl DisplayControl {
  pub const fn new() -&gt; Self {
    Self(0)
  }
  pub const fn video_mode(self) -&gt; u16 {
    self.0 &amp; 0b111
  }
  pub const fn with_video_mode(self, mode: u16) -&gt; Self {
    assert!(mode &lt; 6);
    Self((self.0 &amp; !0b111) | mode)
  }
}
<span class="boring">}</span></code></pre></pre>
<p>We can make a getter for any span of bits by doing a bitwise &quot;and&quot; using a bit mask with those bits.
For bits 0 through 2 that means <code>0b111</code>.</p>
<p>We can make a setter for any span of bits by first clearing the old value (<code>old &amp; !mask</code>),
then merging the cleared value with the new value (<code>cleared | new</code>).</p>
<p>If the bit span doesn't start at 0 we also have to shift the output down, or input up, appropriately.
Here's the background control settings:</p>
<pre><code>4000008h - BG0CNT - BG0 Control (R/W) (BG Modes 0,1 only)
400000Ah - BG1CNT - BG1 Control (R/W) (BG Modes 0,1 only)
400000Ch - BG2CNT - BG2 Control (R/W) (BG Modes 0,1,2 only)
400000Eh - BG3CNT - BG3 Control (R/W) (BG Modes 0,2 only)
  Bit   Expl.
  0-1   BG Priority           (0-3, 0=Highest)
  2-3   Character Base Block  (0-3, in units of 16 KBytes) (=BG Tile Data)
  4-5   Not used (must be zero) (except in NDS mode: MSBs of char base)
  6     Mosaic                (0=Disable, 1=Enable)
  7     Colors/Palettes       (0=16/16, 1=256/1)
  8-12  Screen Base Block     (0-31, in units of 2 KBytes) (=BG Map Data)
  13    BG0/BG1: Not used (except in NDS mode: Ext Palette Slot for BG0/BG1)
  13    BG2/BG3: Display Area Overflow (0=Transparent, 1=Wraparound)
  14-15 Screen Size (0-3)
</code></pre>
<p>In this case, the &quot;character base block&quot; and &quot;screen base block&quot; should be treated as numbers, so we need to shift the bits.
If we had a <code>BackgroundControl</code> type the methods for &quot;character base block&quot; might be like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl BackgroundControl {
  pub const fn character_base_block(self) -&gt; u16 {
    (self.0 &amp; 0b1100) &gt;&gt; 2
  }
  pub const fn with_character_base_block(self, block: u16) -&gt; Self {
    assert!(block &lt; 4);
    Self((self.0 &amp; !0b1100) | (block &lt;&lt; 2))
  }
}
<span class="boring">}</span></code></pre></pre>
<p>Once we've got a <code>DisplayControl</code> type defined, we also want to declare a VolAddress value for it, like we did with the backdrop color.
First we add the <code>display_control</code> module to our <code>prelude</code>, then we can make an entry using it in our <code>mmio</code> module.
The usual name for this address is &quot;DISPCNT&quot;, so we'll go with that:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// mmio.rs
pub const DISPCNT: VolAddress&lt;DisplayControl, Safe, Safe&gt; =
  unsafe { VolAddress::new(0x0400_0000) };
<span class="boring">}</span></code></pre></pre>
<p>From here, mapping out the rest of the GBA's MMIO &quot;just&quot; requires reading GBATEK and making all the necessary data types.
It can take a while, but that's about all there is to it.
In the actual <code>gba</code> crate, there's a lot of macros and helper functions to speed up the work and avoid any copy/paste typos.</p>
<p>Note that not all of the MMIO controls are going to be safe to read and/or write.
It's unsafe to use MMIO controls that can modify the memory that Rust sees or cause UB in any other way.
On the GBA that means the Direct Memory Access (DMA) units.
They're special hardware which can copy data around, and if you point them at the wrong spot they'll copy right over top of Rust's memory.
We'll cover them specifically in a future lesson.</p>
<p>As the end of the lesson, we can write a new example which cuts out our last <code>unsafe</code> block:</p>
<pre><pre class="playground"><code class="language-rust">#![no_std]
#![no_main]

use gba_from_scratch_rs::prelude::*;

#[no_mangle]
extern &quot;C&quot; fn main() -&gt; ! {
  BACKDROP_COLOR.write(Color(0b11111));

  DISPCNT.write(DisplayControl::new());
  loop {}
}

#[panic_handler]
fn handle_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
  loop {}
}</code></pre></pre>
<p>It still doesn't do anything but draw a plain red screen, but every time we cut down on <code>unsafe</code> it's still a win.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../initial-setup/volatile-ops.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../initial-setup/volatile-ops.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
