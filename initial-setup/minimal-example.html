<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A Minimal Example - GBA From Scratch With Rust</title>


        <!-- Custom HTML head -->
        <!-- Open Graph tags-->
        <meta name="og:site_name" content="GBA From Scratch With Rust" />
        <meta name="og:title" content="A Minimal Example" />
        <meta name="og:description" content="" />
        
        <!-- Twitter meta tags -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@lokathor" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../initial-setup/index.html"><strong aria-hidden="true">1.</strong> Initial Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../initial-setup/minimal-example.html" class="active"><strong aria-hidden="true">1.1.</strong> A Minimal Example</a></li><li class="chapter-item expanded "><a href="../initial-setup/calling-main.html"><strong aria-hidden="true">1.2.</strong> Calling main</a></li><li class="chapter-item expanded "><a href="../initial-setup/volatile-ops.html"><strong aria-hidden="true">1.3.</strong> Volatile Ops</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GBA From Scratch With Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Lokathor/gba-from-scratch-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="minimal-example"><a class="header" href="#minimal-example">Minimal Example</a></h1>
<p>The most minimal example we could start with doesn't do anything except avoid crashing.
Still, it's a useful way to check that our tools and project are configured properly.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>#![no_std]
#![no_main]
#![feature(naked_functions)]

<span class="boring">fn main() {
</span>#[naked]
#[no_mangle]
#[instruction_set(arm::a32)]
#[link_section = &quot;.text.gba_rom_header&quot;]
unsafe extern &quot;C&quot; fn __start() -&gt; ! {
  core::arch::asm! {
    &quot;b 1f&quot;,
    &quot;.space 0xE0&quot;,
    &quot;1:&quot;,
    &quot;b 1b&quot;,
    options(noreturn)
  }
}

#[panic_handler]
fn handle_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
  loop {}
}
<span class="boring">}</span></code></pre></pre>
<p>You can put this in your project's <code>examples/</code> directory.
We'll call it <code>min1.rs</code>, and <code>cargo run --example min1</code> should build the example and run it in your runner.
If everything went fine, mGBA should open up and show a white screen and then do nothing, without any error messages.</p>
<p>If there's any problems already that's okay!
There's a lot of small details involved in something like this.
When I was setting things up for this book, and trying to write this minimal example, I messed it up at least three times.
Don't get discouraged too easily!
Double check all the file names, all the file contents, what you typed in the command line, and so on.
You can <a href="https://github.com/Lokathor/gba-from-scratch-rs/issues">open an issue</a> if you need to ask for help.
Alternately, you can try asking in the <a href="https://discord.io/gbadev">GBA Dev Discord</a>.</p>
<p>Let's cover each part of the example one at a time.</p>
<h2 id="crate-inner-attributes"><a class="header" href="#crate-inner-attributes">Crate Inner Attributes</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>#![no_std]
#![no_main]
#![feature(naked_functions)]
<span class="boring">fn main() {
</span><span class="boring">}</span></code></pre></pre>
<p>First we've got several &quot;inner&quot; attributes.
They're like normal attributes but they go just inside of what they affect, rather than just outside of it.
There's no way to have text &quot;outside&quot; of a file, so we have to use inner attributes here.
Inner attributes always have to go first, before any other items like functions or structs or anything like that.
The ordering of the attributes themselves doesn't matter,
I just like sorting them from shortest to longest because it usually looks nice.</p>
<p>First is <a href="https://doc.rust-lang.org/reference/names/preludes.html#the-no_std-attribute">no_std</a>.
This prevents the compiler from automatically linking our program with the <code>std</code> and <code>alloc</code> crates.
The GBA doesn't support <code>std</code> at all, so we'd get a build error if we didn't have <code>no_std</code>.
It's possible to use <code>alloc</code>, but we'd have to do more setup to make it work, so for now we can't.
Even without <code>std</code> available, we can still use a fairly good amount of Rust through the <code>core</code> crate.</p>
<p>Next is the <a href="https://doc.rust-lang.org/reference/crates-and-source-files.html#the-no_main-attribute">no_main</a> attribute.
Normally Rust would provide the actual <code>main</code> symbol which the OS calls at the start of the process.
That function does some environment setup and then calls the main function of the Rust code we wrote.
The compiler doesn't know how to write a <code>main</code> for the GBA though.
So, we just tell it to not even try, and we'll handle that ourselves.</p>
<p>Finally, we have a Nightly feature: <a href="https://github.com/rust-lang/rust/issues/90957">naked functions</a>.
Normally a function has the &quot;prologue&quot; and &quot;epilogue&quot; (the intro and outro) handled by the compiler.
This is for the best, because among other things it's what allows inlining to work.
However, on rare occasions we'll need to have the compiler step back and let us take complete control.
With the <code>naked_functions</code> Nightly feature, we'll be able to use <code>#[naked]</code> on a function when needed.</p>
<h2 id="entry-point"><a class="header" href="#entry-point">Entry Point</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[naked]
#[no_mangle]
#[instruction_set(arm::a32)]
#[link_section = &quot;.text.gba_rom_header&quot;]
unsafe extern &quot;C&quot; fn __start() -&gt; ! {
  core::arch::asm! {
    &quot;b 1f&quot;,
    &quot;.space 0xE0&quot;,
    &quot;1:&quot;,
    &quot;b 1b&quot;,
    options(noreturn)
  }
}
<span class="boring">}</span></code></pre></pre>
<p>This is our <code>__start</code> function.
Normally we'd want to define one in a library, but for now it's fine to define it right in the example.</p>
<p>We call it <code>__start</code> and use <code>#[no_mangle]</code> to match the <code>ENTRY</code> part of our linker script.
Normally Rust would apply name mangling to a function's name so that its symbol name doesn't clash with any other (because name clashes cause a build error).
Using <code>#[no_mangle]</code> stops the name mangling from happening on a particular function or static (but we should limit how much we use it, to avoid those build errors).
It's the same idea as how <code>#[naked]</code> changes the (usually useful) default option into a weirder option.
We also use <code>#[link_section=]</code> to put this function into the &quot;.text.gba_rom_header&quot; section (also because of the linker script).
Section names can be alphanumeric, and they also allow underscores and periods.
The linker script will place the &quot;.text.gba_rom_header&quot; <em>input</em> section at the very start of the &quot;.text&quot; <em>output</em> section during linking.
That means that we'll end up with our <code>__start</code> function, and its header data, at the very start of the ROM.</p>
<p>The last attribute, <code>#[instruction_set(arm::a32)]</code>, sets the function to be encoded as <code>a32</code> instructions.
Because we're building using the <code>thumbv4t-none-eabi</code> target, all functions will <em>default</em> to being <code>t32</code>.
The <code>instruction_set</code> attribute lets us override the default and have an <code>a32</code> function.
Normally our functions can be <code>a32</code> or <code>t32</code>, and <code>t32</code> tends to have better performance by default.
Because of details about the GBA's boot up process (which we'll talk about below), the <code>__start</code> function always has to be <code>a32</code> specifically.</p>
<p>With all of the attributes out of the way, we get to declare the function itself: <code>unsafe extern &quot;C&quot; fn __start() -&gt; !</code>
We're gonna mark <code>__start</code> as <code>unsafe</code> because honestly no one should be calling it from Rust.
Our expectation is that only the BIOS itself will call <code>__start</code>, and only the once at boot.
So we'll just call the fn <code>unsafe</code> and say no one else can call it.
Similarly, because the BIOS will effectively be calling the function, we declare that the function has the <code>extern &quot;C&quot;</code> ABI.
It's Undefined Behavior (UB) for any code other than a Rust function to call a Rust ABI function, so we have to use the C ABI for <code>__start</code>.
It's just the rules.
Finally, we should never return from <code>__start</code>, so we put down the return type as <code>!</code>.
Actually this ends up being just a hint to future readers, because the compiler can't check the body of an inline assembly block.
Still, it's probably a useful hint, and I'm sure that future readers of the code (which might be ourselves!) will appreciate our guidance.</p>
<p>The body of a <code>#[naked]</code> function has to be a single <a href="https://doc.rust-lang.org/reference/inline-assembly.html">asm!</a> block.
Assembly blocks can be multi-line string literals, or they can be a list of string literals (the list is joined with newlines during compilation).
When we put the lines together the assembly looks like this:</p>
<pre><code class="language-arm">b 1f
.space 0xE0
1:
b 1b
</code></pre>
<ul>
<li>The first line is a &quot;branch&quot; (<code>b</code>) to the <code>1</code> label that's &quot;forward&quot; from this instruction (<code>1f</code>). In other words, the label on the third line of our asm block, where it says <code>1:</code>.</li>
<li>The second line is a directive to add blank space to the output. We can tell it's a directive because it starts with a dot. The <code>.space</code> directive just adds blank space to the program. In this case, 0xE0 (224 decimal) bytes of blank space goes right after the branch instruction. That's where the header data goes. For initial development with an emulator it's fine to have a blank header, so more on header stuff will come later. Blank space isn't useful code though, which is why the previous line jumps over the blank space to the label.</li>
<li>The third line <code>1:</code> is a label. We can tell it's a label because it ends with a <code>:</code> character. Within an <code>asm!</code> block you should only use numeric labels, which are always reusable without clashing. If you use <code>global_asm!</code>, or if you write an external assembly file, then you can also use alphanumeric labels if you're careful about which labels you export or not. A label marks the next instruction, either on the same line or on a future line. There can be more than one label pointing to the same instruction, and there can be blank lines between the label and the instruction. The number <code>1</code> itself isn't significant, we could pick any (positive, small-ish) number we like.</li>
<li>The fourth line is a branch to the <code>1</code> label that is &quot;back&quot; from this instruction (<code>1b</code>). This jumps to the label on line 3. That label refers to this instruction. So this instruction just jumps to this instruction, over and over. It's like writing <code>loop {}</code>, just the assembly version of it.</li>
</ul>
<p>In summary: our assembly block just jumps into an infinite loop.
It's not very exciting, but the emulator at least won't crash by trying to execute a blank part of the ROM or whatever.</p>
<h2 id="panic-handler"><a class="header" href="#panic-handler">Panic Handler</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[panic_handler]
fn handle_panic(_: &amp;core::panic::PanicInfo) -&gt; ! {
  loop {}
}
<span class="boring">}</span></code></pre></pre>
<p>Even if the program itself can't actually panic, Rust demands that you define a panic handler function.
During compilation a panic handler that never gets called will be removed, the same as any function that's never called gets removed, but we have to define and then let the compiler decide for itself that it's unused.
As our programs grow we might want to have a panic handler that does something with the panic info.
Send a message to mGBA's debug output, or show something on the screen, or something like that.
Right now we'll start with a &quot;do nothing at all&quot; panic handle though.</p>
<h2 id="why-does-this-work"><a class="header" href="#why-does-this-work">Why Does This Work?</a></h2>
<p>The GBA has an ARM7TDMI CPU.
The ARM7TDMI uses the ARMv4T CPU architecture.
When the CPU turns on, the <code>pc</code> register (&quot;program counter&quot;) is reset to 0, and the CPU begins executing address 0.
This part is just how any ARM CPU works, it's not GBA specific.</p>
<p>Address 0 on the GBA is in the BIOS memory.
That's the &quot;Basic Input Output System&quot;.
The GBA's BIOS data is built into the device itself, separate from whichever cartridge you insert.
The BIOS has the code to play that <a href="https://www.youtube.com/watch?v=6_ZD3FxMcvQ">startup animation</a>, you know the one, with the nice sound.
It also checks the ROM's header data, and will lock the system if the header is incorrect.
We'll talk about header stuff more in a moment, but mGBA doesn't do the header check so for now it's fine to have a blank header.</p>
<p>After the BIOS has done all of its work it will branch to the start of the ROM, <code>0x0800_0000</code>.
That's where the linker script puts the start of the &quot;.text&quot; section.
And at the <em>very start</em> of the &quot;.text&quot; section will be the &quot;.text.gba_rom_header&quot; section.
The Rust compiler won't ever pick that for any code on its own, and we've only assigned one thing to use that section: our <code>__start</code> function.
So our <code>__start</code> function is going to be at the very very start of the ROM.
When the BIOS branches to the start of the ROM, it's branching to the <code>__start</code> function.
Then all the stuff we talked about up above with the four lines of assembly will happen.</p>
<p>And that's the basic idea of how this is working so far.
I still haven't explained the full story on the <code>instruction_set</code> and <code>a32</code> stuff,
but we'll save that for the next example.
For now, you can already call yourself a beginner GBA programmer!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../initial-setup/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../initial-setup/calling-main.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../initial-setup/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../initial-setup/calling-main.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
