<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Calling main - GBA From Scratch With Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../initial-setup/index.html"><strong aria-hidden="true">1.</strong> Initial Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../initial-setup/minimal-example.html"><strong aria-hidden="true">1.1.</strong> A Minimal Example</a></li><li class="chapter-item expanded "><a href="../initial-setup/calling-main.html" class="active"><strong aria-hidden="true">1.2.</strong> Calling main</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GBA From Scratch With Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="calling-main"><a class="header" href="#calling-main">Calling <code>main</code></a></h1>
<p>A program that does nothing except not crash isn't much of a program.
Slightly more pressing is that defining <code>__start</code> within each and every example isn't a great way to do things.
First let's put the <code>__start</code> function in <code>lib.rs</code> so that all our examples will automatically get it when they link with our library.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// lib.rs
#![no_std]
#![feature(naked_functions)]

#[naked]
#[no_mangle]
#[instruction_set(arm::a32)]
#[link_section = &quot;.text.gba_rom_header&quot;]
unsafe extern &quot;C&quot; fn __start() -&gt; ! {
  core::arch::asm! {
    // jump over the header data itself
    &quot;b 1f&quot;,
    &quot;.space 0xE0&quot;,
    &quot;1:&quot;,

    // call to `main`
    &quot;ldr r0, =main&quot;,
    &quot;bx r0&quot;,
    options(noreturn)
  }
}
<span class="boring">}</span></code></pre></pre>
<p>This is <em>mostly</em> the same as before.
The difference is that we've replaced the <code>1: b 1b</code> loop with a call to a function named <code>main</code>.</p>
<pre><code class="language-arm">ldr r0, =main
bx r0
</code></pre>
<ul>
<li><code>ldr reg, =symbol</code> is a &quot;pseudo-instruction&quot; that the assembler supports.
The <code>ldr</code> instruction will &quot;load-register&quot;.
You can load an &quot;immediate&quot; value, which is a small value encoded within the instruction,
or you can load from an address stored in a register.
If you load from an address in a register you can also apply an offset.
This is how pointers to struct fields work: a base pointer and then some offset based on the field's position within a struct.
When we use <code>ldr reg, =symbol</code> the assembler will insert the address of <code>main</code> at the end of the function and then use the <code>pc</code> value (the program counter) as the base address to offset from.
It may sound complicated, but all of the lookups and math are handled for us by the assembler and linker.
We just write the  name of the symbol we want to end up in the register and it'll happen.
We could also write any large constant that doesn't fit in an immediate this way and the assembler will help us out.</li>
<li><code>bx r0</code> is a &quot;branch-exchange&quot; to the address stored in <code>r0</code>.
That's where we put the address of our <code>main</code> function, so the end of <code>__start</code> will branch-exchange to <code>main</code>.
The &quot;branch-exchange&quot; is a special type of branch that lets the CPU switch between ARM code (a32) and Thumb code (t32).
On the GBA's CPU it's the <em>only</em> way for user code to change code modes.
Later ARM CPUs relaxed this restriction, but on the GBA we've got to use <code>bx</code>.
Since <code>__start</code> is always a32 code, and the <code>main</code> function is almost always t32 code, we need to use <code>bx</code> and not just <code>b</code>.
Also of note is that <code>b</code> branches to a <em>label</em>, while <code>bx</code> branch-exchanges to a <em>register</em>.
Sometimes, like now, it's an extra step to load a function's address into a register when we want to use <code>bx</code>.</li>
</ul>
<p>So now we have a <code>__start</code> function that will call a <code>main</code> function.
But where's <code>main</code>?
It's not in the library at all.
It might seem like a problem to call a function that doesn't exist yet, but it's okay.
As long as <em>somewhere</em> defines <code>main</code> when actually linking an executable, the linker will connect everything together just fine.
If we try to make an example that doesn't define a <code>main</code> we'll get a linker error and the build will fail.</p>
<p>Now let's have a look at our second example.
We'll call it <code>min2.rs</code>.</p>
<p>First, we need the example to link to our library.
Normally this would happen automatically when the example calls any functions in the library or uses any types from the library.
Right now the library is nearly empty though, there's nothing to call, nothing to <code>use</code>.
We can force the library to be linked in with an <code>extern crate</code> statement,</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in min2.rs
extern crate gba_from_scratch_rs;
<span class="boring">}</span></code></pre></pre>
<p>This won't be necessary in the future, but for now it will get the job done.</p>
<p>Next we need that <code>main</code> function.</p>
<pre><pre class="playground"><code class="language-rust">// in min2.rs
#[no_mangle]
extern &quot;C&quot; fn main() -&gt; ! {
  unsafe {
    (0x0500_0000 as *mut u16).write_volatile(0b11111);
    (0x0400_0000 as *mut u16).write_volatile(0);
  }
  loop {}
}</code></pre></pre>
<p>Like happened with <code>__start</code>, we need <code>main</code> to be <code>#[no_mangle]</code>.
This will allow the library to link with it during the linking of the executable.
Also like with <code>__start</code>, the return type of <code>main</code> will be <code>-&gt; !</code>, because we should never return from <code>main</code> back to <code>__start</code>.</p>
<p>The actual code in the body of <code>main</code> is two volatile writes.
These are to Memory-mapped IO (MMIO) addresses, which are how the CPU controls the rest of the hardware.
Most of learning to use the GBA well boils down to learning what all the MMIO controls allow for.</p>
<p>The first <code>write_volatile</code> call sets the color of the backdrop, the color that's shown for a pixel when nothing else is shown there.
Color values on the GBA are 5 bits per channel, red as the lowest bits, then green, then blue.</p>
<p>The second <code>write_volatile</code> sets the &quot;display control&quot; to 0.
When the BIOS first transfers control to our program, the display control is set with the &quot;forced blank&quot; bit on.
This is why the <code>min1</code> example was all white, because display was forced to be &quot;blank&quot;.
When we write 0 to the display control this disables the forced blank bit, allowing normal video display.
Since we haven't set anything else anywhere, the whole screen will be the backdrop color (which we set to red).</p>
<p>This means that our entire example does nothing but turn the screen red.
Still not very interactive, but it's some progress.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../initial-setup/minimal-example.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../initial-setup/minimal-example.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
