<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Initial Setup - GBA From Scratch With Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../initial-setup/index.html" class="active"><strong aria-hidden="true">1.</strong> Initial Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../initial-setup/minimal-example.html"><strong aria-hidden="true">1.1.</strong> A Minimal Example</a></li><li class="chapter-item expanded "><a href="../initial-setup/calling-main.html"><strong aria-hidden="true">1.2.</strong> Calling main</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GBA From Scratch With Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="initial-setup"><a class="header" href="#initial-setup">Initial Setup</a></h1>
<blockquote>
<p>If you want to make an apple pie from scratch, you must first invent the universe.</p>
</blockquote>
<p>In other words, we've got a lot of setup ahead of us.</p>
<h1 id="system-tooling-setup"><a class="header" href="#system-tooling-setup">System Tooling Setup</a></h1>
<p>Separately from setting up a specific project's configuration, you'll need to do a few &quot;one time&quot; things to make your machine ready.</p>
<p>First of all, we'll need to be using the Nightly rust compiler, because we'll be using a lot of unstable features.</p>
<p>Next, we'll need to have the <code>rust-src</code> rustup component available, because we'll have to build our own copy of the standard library.</p>
<p>Finally, we'll need the ARM binutils because LLVM's linker doesn't currently support the GBA's old CPU (but support is in the works).
You can get the ARM binutils for Windows and Mac from the <a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">ARM Developer Website</a>.
If you're on Linux then you can probably find them in your package manager.
We want a set of binutils for <code>arm-none-eabi</code>.</p>
<p>Here's the lines to make the (ubuntu based) CI run:</p>
<pre><code class="language-sh">rustup default nightly
rustup component add rust-src
sudo apt-get install -y binutils-arm-none-eabi
</code></pre>
<p>The <code>rust-src</code> component will be specific to Nightly or Stable, so be sure to set Nightly before installing it.
Otherwise you'll just have to install it a second time after setting Nightly for use.</p>
<p>The rustup commands should work just as well on Windows and Mac.
If you're on a Linux that isn't Ubuntu then the binutils package could be under some other name.</p>
<p><strong>Note:</strong> <code>rustup default nightly</code> is a global command and will affect all your rust stuff.
If you want to sets nightly for <em>only</em> your GBA project the consider a <a href="https://rust-lang.github.io/rustup/overrides.html?#the-toolchain-file">toolchain file</a> instead.</p>
<p>We'll also need a tool called <code>gbafix</code>, which can patch up the ROM's header data.
There's a <a href="https://github.com/devkitPro/gba-tools">C version</a> of that if you want,
but there's also a rust one too, and you can just get the Rust version via <code>cargo install</code>.</p>
<pre><code class="language-sh">cargo install gbafix
</code></pre>
<h1 id="project-configuration"><a class="header" href="#project-configuration">Project Configuration</a></h1>
<p>In addition to the system level setup, we'll want to set a few project configuration files before we begin working on the actual code.</p>
<h2 id="cargotoml"><a class="header" href="#cargotoml"><code>Cargo.toml</code></a></h2>
<p>Running the usual <code>cargo init</code> will make a default <code>Cargo.toml</code> file.
This is mostly fine, but I strongly suggest that we alter the &quot;dev&quot; build profile slightly.
The dev profile is what's used for debug builds.
Normally the dev profile is set for a low level of optimization and using incremental building.
This lets debug builds complete quickly, though the resulting programs run an order of magnitude (or more) slower than a release build.
The GBA has a very weak CPU, so taking such a performance hit, even just in debug builds, is very bad for us.</p>
<p>We want to turn the <code>opt-level</code> up to 3, and turn <code>incremental</code> off.</p>
<p>Also, we can use a package override to turn <code>debug-assertions</code> off in our dependencies.
We won't have any normal dependencies, but we'll be using the <code>build-std</code> nightly feature of <code>cargo</code>.
When <code>cargo</code> builds the standard library it'll pull in <code>compiler_builtins</code>, and we want that to avoid those debug asserts.</p>
<pre><code class="language-toml">[profile.dev]
opt-level = 3
incremental = false

[profile.dev.package.&quot;*&quot;]
debug-assertions = false
</code></pre>
<h2 id="cargoconfigtoml"><a class="header" href="#cargoconfigtoml"><code>.cargo/config.toml</code></a></h2>
<p>In our project folder make a <code>.cargo/</code> folder, then make a <code>cargo.toml</code> file inside.
This lets us change a few more cargo defaults so that we don't need to pass as many command line arguments all the time.</p>
<p>First of all, our default target for all of our builds will be <code>thumbv4t-none-eabi</code>.
There's two targets built in to <code>rustc</code> that could work on the GBA:</p>
<ul>
<li><code>thumbv4t-none-eabi</code> produces &quot;thumb code&quot; by default</li>
<li><code>armv4t-none-eabi</code> produces &quot;arm code&quot; by default</li>
</ul>
<p>We'll cover the thumb/arm differences later,
for now just know that we'll want a majority of our code to be thumb code so we'll be building with <code>thumbv4t-none-eabi</code>.
We can set this with <code>--target=thumbv4t-none-eabi</code>, but we can also use a <code>[build]</code> entry.</p>
<pre><code class="language-toml">[build]
target = &quot;thumbv4t-none-eabi&quot;
</code></pre>
<p>The thing is, there's no standard library shipped for this target, it's only &quot;<a href="https://doc.rust-lang.org/rustc/target-tier-policy.html">Tier 3</a>&quot;.
This isn't a very big problem, because a Nightly feature of <code>cargo</code> lets us build it ourselves.
It makes a fresh project build take an extra few seconds, but that's it.
We could do this with <code>-Zbuild-std=core</code>, or we can use an <code>[unstable]</code> entry.</p>
<pre><code class="language-toml">[unstable]
build-std = [&quot;core&quot;]
</code></pre>
<p>Last up is that we want to set some per-target details.
With a <code>runner</code> we can name a program that will run our programs.
This is designed to support emulators and simulators and the like, which is exactly what we want.
My GBA emulator of choice is <a href="https://mgba.io/">mGBA</a> because it supports running ELF files directly.
This greatly simplifies the process of running our game in the emulator during development.
We set mGBA as the <code>runner</code>, then <code>cargo</code> passes our ELF formatted executable as an arg to mGBA, and things will &quot;just work&quot;.
On Linux and Mac you'll get two executables when you install mGBA: <code>mgba</code> will have no GUI controls, and <code>mgba-qt</code> will have GUI controls.
On Windows there's just one executable: <code>mgba.exe</code>.
Personally, on my Windows machine I just made a copy of <code>mgba.exe</code> called <code>mgba-qt.exe</code> so that &quot;mgba-qt&quot; works all the time.</p>
<p>In addition to the <code>runner</code>, we need to set some special <code>rustflags</code>.
There's a special argument we need to pass to the linker.
We do this with <code>-Clink-arg=</code>, followed by the argument.
The linker argument itself that we need to pass will be to set the linker script.
We do this with <code>-T</code>, followed by the script's filename.
I'm going to suggest having a folder called <code>linker_scripts/</code>, and then a script called <code>mono_boot.ld</code>.
That means that our <code>[target.thumbv4t-none-eabi]</code> entry will look like this</p>
<pre><code class="language-toml">[target.thumbv4t-none-eabi]
runner = &quot;mgba-qt&quot;
rustflags = [&quot;-Clink-arg=-Tlinker_scripts/mono_boot.ld&quot;]
</code></pre>
<p>The linker script file itself is complicated enough to deserve its own sub-header.</p>
<h2 id="linker_scriptsmono_bootld"><a class="header" href="#linker_scriptsmono_bootld"><code>linker_scripts/mono_boot.ld</code></a></h2>
<p>In a folder called <code>linker_scripts/</code> we want a file called <code>mono_boot.ld</code>.
This is a configuration file for the linker.</p>
<p>The actual content of the linker script is long enough that I won't paste it all in here.
Just get it out of the github repo: <a href="https://github.com/Lokathor/gba-from-scratch-rs/blob/main/linker_scripts/mono_boot.ld">mono_boot.ld</a></p>
<p>There is a <a href="https://sourceware.org/binutils/docs/ld/">sizable manual</a> for how the linker works.
It includes a full description of how linker scripts operate.
Actually understanding how the linker script works isn't necessary right now, or ever.
The only reason we need this extra linker script file at all is because the GBA is a more obscure target than a desktop or phone or something like that.
If we were compiling for a common platform the compiler would still follow a linker script, it would just use one that came with the linker instead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../initial-setup/minimal-example.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../initial-setup/minimal-example.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
